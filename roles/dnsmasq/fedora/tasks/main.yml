---

- name: Install dsmasq package
  dnf:
    name: dnsmasq
    state: latest

- name: Stop and disable dnsmasq service
  systemd:
    name: dnsmasq
    state: stopped
    enabled: no
    masked: yes

- name: Configure NetworkManager to use dnsmasq
  copy:
    dest: /etc/NetworkManager/conf.d/dnsmasq.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      [main]
      dns=dnsmasq
  register: networkmanager_dnsmasq_config

- name: Configure NetworkManager dnsmasq cache
  copy:
    dest: /etc/NetworkManager/dnsmasq.d/cache.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      cache-size=1000
  register: dnsmasq_cache_config

- name: Stop and disable systemd-resolved
  systemd:
    name: systemd-resolved
    state: stopped
    enabled: no
    masked: yes

- name: Configure /etc/resolv.conf
  copy:
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      # Generated by NetworkManager
      nameserver 127.0.1.1
  register: resolvconf_updated

- name: Restart NetworkManager service
  systemd:
    name: NetworkManager
    state: restarted
  when: networkmanager_dnsmasq_config.changed or dnsmasq_cache_config.changed or resolvconf_updated.changed
  register: networkmanager_service

- name: Restart wpa_supplicant service
  systemd:
    name: wpa_supplicant
    state: restarted
  when: networkmanager_service.changed
