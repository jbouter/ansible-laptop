---

- name: Create "docker" group
  group:
    name: docker
    state: present
    system: yes

- name: Configure passwordless sudo for wireguard commands
  copy:
    dest: /etc/sudoers.d/wireguard
    owner: root
    group: root
    mode: '0440'
    content: |
      #Allow members of group sudo to execute wireguard commands
      Cmnd_Alias WIREGUARD = /usr/bin/wg show, \
                              /usr/bin/wg-quick up wg[0-9], \
                              /usr/bin/wg-quick down wg[0-9]

      %sudo ALL = NOPASSWD: WIREGUARD
      %wheel ALL = NOPASSWD: WIREGUARD

- name: Configure passwordless sudo for fwupdmgr commands
  copy:
    dest: /etc/sudoers.d/fwupd
    owner: root
    group: root
    mode: '0440'
    content: |
      #Allow members of group sudo to execute wireguard commands
      Cmnd_Alias FWUPD = /usr/bin/fwupdmgr update, \
                         /usr/bin/fwupdmgr upgrade, \
                         /usr/bin/fwupdmgr refresh

      %sudo ALL = NOPASSWD: FWUPD
      %wheel ALL = NOPASSWD: FWUPD

- name: Configure passwordless sudo for flatpak commands
  copy:
    dest: /etc/sudoers.d/flatpak
    owner: root
    group: root
    mode: '0440'
    content: |
      #Allow members of group sudo to execute wireguard commands
      Cmnd_Alias FLATPAK = /usr/bin/flatpak update, \
                           /usr/bin/flatpak install *, \
                           /usr/bin/flatpak uninstall *

      %sudo ALL = NOPASSWD: FLATPAK
      %wheel ALL = NOPASSWD: FLATPAK

- name: Install bash completion for git
  get_url:
    url: https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash
    dest: /etc/bash_completion.d/git-completion.bash
    mode: '0640'
    owner: root
    group: root

- name: Configure bashrc for the user on Debian
  template:
    src: bashrc.j2
    dest: "/home/{{ username }}/.bashrc"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

- name: Configure bash_aliases for the user
  copy:
    src: bash_aliases
    dest: "/home/{{ username }}/.bash_aliases"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

- name: Configure profile for the user
  copy:
    src: profile
    dest: "/home/{{ username }}/.profile"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

- name: Configure bashrc for root
  template:
    src: bashrc.j2
    dest: "/root/.bashrc"
    owner: root
    group: root
    mode: '0644'
  when: ansible_os_family == "Debian"

- name: Configure bash_aliases for root
  copy:
    src: bash_aliases
    dest: "/root/.bash_aliases"
    owner: root
    group: root
    mode: '0644'

- name: Configure profile for root
  copy:
    src: profile
    dest: "/root/.profile"
    owner: root
    group: root
    mode: '0644'

- name: Ensure user vimrc has been removed
  file:
    dest: "/home/{{ username }}/.vimrc"
    state: absent

- name: Clone vim repository to user
  become: yes
  become_user: "{{ username }}"
  git:
    repo: https://github.com/roaldnefs/.vim.git
    dest: "/home/{{ username }}/.vim"
    version: main
  notify:
    - Install vim repository

- name: Ensure root vimrc has been removed
  file:
    dest: /root/.vimrc
    state: absent

- name: Configure vim for root
  file:
    src: "/home/{{ username }}/.vim"
    dest: /root/.vim
    owner: root
    group: root
    state: link

- name: Check if user's git config exists
  stat:
    path: "/home/{{ username }}/.gitconfig"
  register: stat_user_gitconfig

- name: Configure git for user
  template:
    src: gitconfig.j2
    dest: "/home/{{ username }}/.gitconfig"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'
  when: not stat_user_gitconfig.stat.exists

- name: Configure local directories for user
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'
  loop:
    - "/home/{{ username }}/.local"
    - "/home/{{ username }}/.local/bin"
    - "/home/{{ username }}/.local/share"
    - "/home/{{ username }}/.local/share/neofetch"
